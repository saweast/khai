(function(e){"use strict";e.fn.imageAttachment=function(t){if(this.length){this.each(function(){a(e(this),t)})}};function a(a,t){var r=e(".progress-overlay",a);var s=e(".upload-progress",a);var n=e(".remove_image",a);var i=e(".file_label",a);t.csrfToken=t.csrfToken||e("meta[name=csrf-token]").attr("content");t.csrfTokenName=t.csrfTokenName||e("meta[name=csrf-param]").attr("content");var o=t.hasImage||false;var f=t.apiUrl||"";var l=t.previewUrl||"";var c=t.previewWidth||300;var d=t.previewHeight||200;var v=e(".preview",a);var u=e("img",v);v.css({width:c+"px",height:d+"px"});if(o){p(l)}else{i.text(i.data("upload-text"))}function p(e){if(e){console.log(e);l=e;o=true;a.addClass("with-image");u.attr("src",l);n.removeClass("disabled");i.text(i.data("replace-text"))}else{a.removeClass("with-image");u.removeAttr("src");n.addClass("disabled");i.text(i.data("upload-text"))}}n.click(function(){if(o){e.ajax({type:"POST",url:f,data:"remove=true"+(t.csrfToken?"&"+t.csrfTokenName+"="+t.csrfToken:""),dataType:"json"}).done(function(e){o=false;p()})}});if(window.FormData!==undefined){var h=e(".afile",a).attr("name");var m=function(e){if(e.length==0)return;r.show();s.css("width","5%");var a=e.length;for(var n=0;n<a;n++){var i=new FormData;i.append(h,e[n]);if(t.csrfToken){i.append(t.csrfTokenName,t.csrfToken)}var o=new XMLHttpRequest;o.open("POST",f,true);o.onload=function(){if(this.status==200){var e=JSON.parse(this.response);p(e.previewUrl)}else{console.log(this.response)}s.css("width","100%");r.hide()};o.send(i)}};(function(){var e=a[0];var t=false;var r=false;setInterval(function(){if(t!=r){if(t)e.classList.add("over");else e.classList.remove("over");r=t}},30);function s(e){e.preventDefault();t=true;return false}function n(){t=false;return false}function i(e){e.preventDefault();e.stopPropagation();var a=e.dataTransfer.files;m(a);t=false;return false}function o(){t=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",n,false);e.addEventListener("drop",i,false);e.addEventListener("dragend",o,false)})();e(".afile",a).on("change",function(e){e.preventDefault();m(this.files)})}else{e(".afile",a).on("change",function(a){a.preventDefault();r.show();s.css("width","5%");var n={};if(t.csrfToken)n[t.csrfTokenName]=t.csrfToken;e.ajax({type:"POST",url:f,data:n,files:e(this),iframe:true,processData:false,dataType:"json"}).done(function(e){p(e.previewUrl);s.css("width","100%");r.hide()})})}}})(jQuery);